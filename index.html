<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ganado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes highlight-flash {
            0% { background-color: white; }
            30% { background-color: #dbeafe; }
            100% { background-color: white; }
        }
        
        .highlight-animation {
            animation: highlight-flash 2s ease-out;
        }

        /* Estilos de Pesta√±as */
        .tab-button.active {
            border-color: #1e40af; /* blue-700 */
            color: #1e40af;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .item-lote {
            border-left-width: 8px; /* Borde ancho para lotes */
        }
    </style>

</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">

        <h1 class="text-3xl font-bold text-blue-800 mb-6">Gestor de Ganado</h1>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Escaneos Pendientes por Registrar</h2>
            <p id="cargando-pendientes" class="text-gray-500">Iniciando...</p>
            <ul id="lista-pendientes" class="space-y-2">
                </ul>
        </div>

        <hr class="my-8">

        <div id="formulario-registro" class="hidden bg-blue-50 p-6 rounded-lg mb-8">
            <h2 id="formulario-titulo" class="text-2xl font-semibold mb-4">Registrar Ganado</h2>
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">UID</label>
                    <input type="text" id="form-uid" readonly class="mt-1 block w-full p-2 bg-gray-200 border-gray-300 rounded-md shadow-sm">
                    <input type="hidden" id="form-scan-id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre / Identificador</label>
                    <input type="text" id="form-nombre" placeholder="Ej: Manchitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sexo</label>
                    <select id="form-sexo" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="hembra">Hembra</option>
                        <option value="macho">Macho</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Edad (a√±os)</label>
                    <input type="number" id="form-edad-anos" value="0" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Edad (meses)</label>
                    <input type="number" id="form-edad-meses" value="0" min="0" max="11" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" id="form-peso" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>

                <div id="campo-estado-macho" class="hidden col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="form-estado-macho" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="reproduccion">Reproducci√≥n</option>
                        <option value="venta">Venta / Engorde</option>
                    </select>
                </div>
            </div>

            <div id="campos-hembra" class="grid grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">N√∫mero de Partos</label>
                    <input type="number" id="form-partos" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">¬øEmbarazada?</label>
                    <select id="form-embarazada" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="false">No</option>
                        <option value="true">S√≠</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha del √∫ltimo parto</label>
                    <input type="date" id="form-ultimo-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div id="campo-fecha-estimada" class="hidden col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Fecha estimada del parto</label>
                    <input type="date" id="form-estimada-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button id="btn-guardar" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar Ganado</button>
                <button id="btn-cancelar" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
            </div>
        </div>

        <hr class="my-8">

        <div class="mb-4 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" id="tab-nav">
                <button class="tab-button active pb-2 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="inventario">
                    Mi Inventario
                </button>
                <button class="tab-button pb-2 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="pronostico">
                    Pron√≥stico de Partos üçº
                </button>
                <button class="tab-button pb-2 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700" data-tab="lotes">
                    Lotes de Venta üìà
                </button>
            </nav>
        </div>

        <div id="tab-content-container">
            
            <div id="inventario" class="tab-content active">
                <h2 class="text-xl font-semibold mb-4">Inventario General</h2>
                <div class="mb-4 flex space-x-4">
                    <div class="w-full">
                        <label for="input-buscador" class="block text-sm font-medium text-gray-700">Buscar por nombre/UID:</label>
                        <input type="text" id="input-buscador" placeholder="Escribe un nombre..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    
                    <div class="w-1/3">
                        <label for="select-filtro-sexo" class="block text-sm font-medium text-gray-700">Filtrar Sexo:</label>
                        <select id="select-filtro-sexo" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="todos">Todos</option>
                            <option value="hembra">Hembras</option>
                            <option value="macho">Machos</option>
                        </select>
                    </div>
                </div>

                <p id="cargando-inventario" class="text-gray-500">Cargando datos...</p>
                <div id="lista-inventario" class="space-y-4">
                    </div>
            </div>

            <div id="pronostico" class="tab-content">
                <h2 class="text-xl font-semibold mb-4 text-green-700">Partos m√°s Cercanos</h2>
                <p id="cargando-pronostico" class="text-gray-500">Analizando registros de hembras pre√±adas...</p>
                <div id="lista-pronostico" class="space-y-4">
                    </div>
            </div>
            
            <div id="lotes" class="tab-content">
                <h2 class="text-xl font-semibold mb-4 text-orange-700">Gesti√≥n de Lotes de Venta</h2>
                
                <div class="bg-orange-50 p-4 rounded-lg shadow-inner mb-6">
                    <h3 class="text-lg font-medium mb-3">Crear Nuevo Lote</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Nombre del Lote</label>
                            <input type="text" id="lote-nombre" placeholder="Ej: Lote Engorde 3M-Enero" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Duraci√≥n (meses)</label>
                            <select id="lote-duracion" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="3">3 meses (Engorde R√°pido)</option>
                                <option value="6">6 meses (Est√°ndar)</option>
                                <option value="12">12 meses (Ciclo Completo)</option>
                            </select>
                        </div>
                        <div>
                            <button id="btn-crear-lote" class="mt-6 bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 w-full">
                                Crear Lote
                            </button>
                        </div>
                    </div>
                    <p id="lote-fecha-estimada" class="mt-3 text-sm text-gray-600">
                        Fecha de inicio: <strong id="lote-fecha-inicio">Hoy</strong>. Fecha de venta estimada: <strong id="lote-fecha-venta-est">Se calcular√° al crear</strong>.
                    </p>
                </div>
                
                <h3 class="text-lg font-medium mb-3 mt-8">Lotes Activos</h3>
                <p id="cargando-lotes" class="text-gray-500">Cargando lotes...</p>
                <div id="lista-lotes" class="space-y-4">
                    </div>
            </div>

        </div> </div>

    <script type="module">
        // Importamos solo las funciones que necesitamos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, 
            setDoc, deleteDoc, getDocs, query,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        import { 
            getAuth, 
            signInWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";


        // --- 1. CONFIGURACI√ìN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFeLhhCLU2TUQUJjG8IsfUG3JBTc-xyTM",
            authDomain: "proyectocorralpin.firebaseapp.com",
            projectId: "proyectocorralpin",
            storageBucket: "proyectocorralpin.appspot.com",
            messagingSenderId: "1058204128531",
            appId: "1:1058204128531:web:dd88871038c1a7c3e5362a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias a elementos del HTML
        const listaPendientesUI = document.getElementById('lista-pendientes');
        const cargandoPendientesUI = document.getElementById('cargando-pendientes');
        const formularioUI = document.getElementById('formulario-registro');
        const formularioTituloUI = document.getElementById('formulario-titulo');
        const btnGuardar = document.getElementById('btn-guardar');
        const btnCancelar = document.getElementById('btn-cancelar');
        const inventarioUI = document.getElementById('lista-inventario');
        const cargandoInventarioUI = document.getElementById('cargando-inventario');
        const selectEmbarazada = document.getElementById('form-embarazada');
        const campoFechaEstimada = document.getElementById('campo-fecha-estimada');
        const inputUltimoParto = document.getElementById('form-ultimo-parto');
        const inputFechaEstimada = document.getElementById('form-estimada-parto');
        const inputBuscador = document.getElementById('input-buscador');
        const selectSexo = document.getElementById('form-sexo');
        const camposHembraUI = document.getElementById('campos-hembra');
        const inputPartos = document.getElementById('form-partos');
        const campoEstadoMacho = document.getElementById('campo-estado-macho');
        const selectEstadoMacho = document.getElementById('form-estado-macho');
        const selectFiltroSexo = document.getElementById('select-filtro-sexo');
        const listaPronosticoUI = document.getElementById('lista-pronostico');
        const cargandoPronosticoUI = document.getElementById('cargando-pronostico');
        
        // ¬°NUEVOS! Elementos para Lotes
        const listaLotesUI = document.getElementById('lista-lotes');
        const cargandoLotesUI = document.getElementById('cargando-lotes');
        const btnCrearLote = document.getElementById('btn-crear-lote');
        const inputLoteNombre = document.getElementById('lote-nombre');
        const selectLoteDuracion = document.getElementById('lote-duracion');
        
        // Variables globales
        let uidsDeGanado = new Set();
        let inventarioCache = []; 
        let lotesCache = []; // Nuevo cache para lotes

        // --- FUNCI√ìN DE INICIO (Autenticaci√≥n) ---
        async function iniciarSistema() {
            try {
                cargandoPendientesUI.innerText = "Autenticando...";
                cargandoInventarioUI.innerText = "Autenticando...";
                cargandoLotesUI.innerText = "Autenticando...";
                
                await signInWithEmailAndPassword(auth, "enndels@gmail.com", "123456789");
                console.log("¬°P√°gina web autenticada con √©xito!");

                escucharInventario(); 
                escucharEscaneosPendientes();
                escucharLotes(); // ¬°INICIAMOS LA ESCUCHA DE LOTES!

            } catch (error) {
                console.error("¬°Error fatal al autenticar la p√°gina!", error.code, error.message);
                cargandoPendientesUI.innerText = "Error de autenticaci√≥n.";
                cargandoInventarioUI.innerText = "Error de autenticaci√≥n.";
                cargandoLotesUI.innerText = "Error de autenticaci√≥n.";
            }
        }
        
        // --- L√ìGICA DE TABS (PESTA√ëAS) ---
        document.getElementById('tab-nav').addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                const targetTab = e.target.dataset.tab;

                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                e.target.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                if (targetTab === 'pronostico') {
                    renderizarPronosticoPartos();
                } else if (targetTab === 'lotes') {
                    renderizarLotes();
                } else if (targetTab === 'inventario') {
                    renderizarInventario();
                }
            }
        });

        // --- ESCUCHAR ESCANEOS PENDIENTES (omitiendo c√≥digo interno por brevedad, es igual a v4.15) ---
        function escucharEscaneosPendientes() {
            const scansRef = collection(db, "public_scans");
            onSnapshot(scansRef, (snapshot) => {
                let hayPendientes = false;
                listaPendientesUI.innerHTML = ''; 

                snapshot.docs.forEach(async (doc) => {
                    const scan = doc.data();
                    const scanId = doc.id; 
                    
                    if (uidsDeGanado.has(scan.uid)) {
                        const vacaCard = document.getElementById(`vaca-${scan.uid}`);
                        if (vacaCard) {
                            vacaCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            vacaCard.classList.add('highlight-animation');
                            setTimeout(() => { vacaCard.classList.remove('highlight-animation'); }, 2000);
                        }
                        const scanRef = doc(db, "public_scans", scanId);
                        await deleteDoc(scanRef);
                    } else {
                        hayPendientes = true;
                        let timestampStr = scan.timestamp ? new Date(scan.timestamp).toLocaleString('es-GT') : "Fecha desconocida";

                        const item = document.createElement('li');
                        item.className = "flex justify-between items-center p-3 bg-gray-50 rounded shadow-sm";
                        item.innerHTML = `
                            <span>UID: <strong class="font-mono">${scan.uid}</strong> (Escaneado: ${timestampStr})</span>
                            <button data-uid="${scan.uid}" data-scan-id="${scanId}" class="btn-registrar bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                Registrar
                            </button>
                        `;
                        listaPendientesUI.appendChild(item);
                    }
                }); 

                cargandoPendientesUI.style.display = hayPendientes ? 'none' : 'block';
                if (!hayPendientes) cargandoPendientesUI.innerText = "No hay escaneos pendientes.";
            });
        }

        // --- L√ìGICA DEL FORMULARIO Y GUARDADO (igual a v4.15) --- 
        function mostrarFormulario(uid, scanId) {
            // ... (c√≥digo para mostrar/limpiar formulario) ...
            formularioTituloUI.innerText = scanId ? "Registrar Nuevo Ganado" : "Editar Ganado";
            document.getElementById('form-uid').value = uid;
            document.getElementById('form-scan-id').value = scanId || '';
            
            document.getElementById('form-nombre').value = '';
            document.getElementById('form-peso').value = '';
            document.getElementById('form-edad-anos').value = 0;
            document.getElementById('form-edad-meses').value = 0;
            selectSexo.value = 'hembra'; 
            
            inputPartos.value = 0;
            selectEmbarazada.value = 'false';
            inputUltimoParto.value = '';
            inputFechaEstimada.value = '';
            selectEstadoMacho.value = 'reproduccion';
            
            camposHembraUI.classList.remove('hidden');
            campoFechaEstimada.classList.add('hidden');
            campoEstadoMacho.classList.add('hidden'); 
            
            formularioUI.classList.remove('hidden');
            formularioUI.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Event listeners para formulario
        listaPendientesUI.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-registrar')) {
                mostrarFormulario(e.target.dataset.uid, e.target.dataset.scanId);
            }
        });
        btnCancelar.addEventListener('click', () => { formularioUI.classList.add('hidden'); });
        selectEmbarazada.addEventListener('change', (e) => {
            if (e.target.value === 'true') { campoFechaEstimada.classList.remove('hidden'); } 
            else { campoFechaEstimada.classList.add('hidden'); inputFechaEstimada.value = ''; }
        });
        selectSexo.addEventListener('change', (e) => {
            if (e.target.value === 'macho') {
                camposHembraUI.classList.add('hidden');
                campoFechaEstimada.classList.add('hidden');
                campoEstadoMacho.classList.remove('hidden');
            } else {
                camposHembraUI.classList.remove('hidden');
                campoEstadoMacho.classList.add('hidden');
            }
        });
        
        btnGuardar.addEventListener('click', async () => {
            // ... (c√≥digo de guardado y validaci√≥n igual a v4.15) ...
            const uid = document.getElementById('form-uid').value;
            const scanId = document.getElementById('form-scan-id').value; 
            
            const nombre = document.getElementById('form-nombre').value;
            const sexo = selectSexo.value;
            const peso = parseInt(document.getElementById('form-peso').value) || 0;
            
            const edadAnos = parseInt(document.getElementById('form-edad-anos').value) || 0;
            const edadMeses = parseInt(document.getElementById('form-edad-meses').value) || 0;
            
            const edadTotalMeses = (edadAnos * 12) + edadMeses;
            const edadDecimal = edadAnos + (edadMeses / 12); 

            let partos = 0;
            let estaEmbarazada = false;
            let ultimoParto = null;
            let estimadaParto = null;
            let estadoMacho = null;

            if (!nombre || !uid || peso <= 0 || edadTotalMeses < 0 || edadAnos > 18) {
                alert("Error: Verifica todos los campos (Nombre, UID y Peso deben ser v√°lidos; Edad m√°x 18 a√±os).");
                return;
            }
            
            if (sexo === 'hembra') {
                partos = parseInt(inputPartos.value) || 0;
                estaEmbarazada = selectEmbarazada.value === 'true';
                ultimoParto = inputUltimoParto.value || null;
                estimadaParto = estaEmbarazada ? (inputFechaEstimada.value || null) : null;

                if (partos > edadAnos) { 
                    alert("Error: El n√∫mero de partos no puede ser mayor que la edad en a√±os.");
                    return; 
                }
                if (estaEmbarazada && edadTotalMeses < 12) {
                    alert("Error: Una hembra debe tener al menos 1 a√±o (12 meses) para estar registrada como embarazada.");
                    return;
                }
            } else if (sexo === 'macho') {
                estadoMacho = selectEstadoMacho.value;
            }

            const datosGanado = {
                uid: uid, nombre: nombre, sexo: sexo, peso: peso,
                edadAnos: edadAnos, edadMeses: edadMeses, edadDecimal: parseFloat(edadDecimal.toFixed(2)),
                partos: partos, embarazada: estaEmbarazada, ultimoParto: ultimoParto, 
                estimadaParto: estimadaParto, estadoMacho: estadoMacho
            };

            try {
                const ganadoRef = doc(db, "ganado", uid);
                await setDoc(ganadoRef, datosGanado, { merge: true });

                if (scanId) {
                    const scanRef = doc(db, "public_scans", scanId);
                    await deleteDoc(scanRef);
                    alert("¬°Ganado registrado con √©xito!");
                } else {
                    alert("¬°Ganado actualizado con √©xito!");
                }
                
                formularioUI.classList.add('hidden');
            } catch (error) {
                console.error("Error al guardar:", error);
                alert("Error al guardar el ganado.");
            }
        });


        // ==================================================================
        // --- ESCUCHA CONTINUA DEL INVENTARIO (v4.16) --- 
        // ==================================================================
        function escucharInventario() {
            const ganadoRef = collection(db, "ganado");

            onSnapshot(ganadoRef, (querySnapshot) => {
                cargandoInventarioUI.style.display = 'none';
                uidsDeGanado.clear();
                inventarioCache = []; 
                
                if (querySnapshot.empty) {
                    cargandoInventarioUI.innerText = 'A√∫n no hay ganado registrado.';
                    cargandoInventarioUI.style.display = 'block';
                    inventarioUI.innerHTML = '';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    uidsDeGanado.add(doc.id);
                    inventarioCache.push(doc.data());
                });
                
                // Renderizamos todas las vistas que dependen del inventario
                renderizarInventario(); 
                if (document.getElementById('pronostico').classList.contains('active')) {
                    renderizarPronosticoPartos();
                }
                // Si la pesta√±a de lotes estuviera activa, tambi√©n se renderizar√≠a aqu√≠, pero su fuente principal es lotesCache.
            });
        }

        // ==================================================================
        // --- ¬°NUEVO! L√ìGICA DE LOTES DE VENTA (v4.16) ---
        // ==================================================================
        
        // --- A. ESCUCHA CONTINUA DE LOTES ---
        function escucharLotes() {
            const lotesRef = collection(db, "lotes_venta");

            onSnapshot(lotesRef, (querySnapshot) => {
                cargandoLotesUI.style.display = 'none';
                lotesCache = []; 
                
                if (querySnapshot.empty) {
                    cargandoLotesUI.innerText = 'No hay lotes de venta activos.';
                    cargandoLotesUI.style.display = 'block';
                    listaLotesUI.innerHTML = '';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const lote = doc.data();
                    lote.id = doc.id; // Guardamos el ID del documento
                    lotesCache.push(lote);
                });
                
                // Renderizamos la lista de lotes
                renderizarLotes(); 
            });
        }
        
        // --- B. RENDERIZADO DE LOTES ---
        function renderizarLotes() {
            listaLotesUI.innerHTML = '';
            
            // Ordenamos los lotes por fecha de venta estimada (m√°s cercana primero)
            lotesCache.sort((a, b) => {
                const fechaA = new Date(a.fechaVentaEstimada).getTime();
                const fechaB = new Date(b.fechaVentaEstimada).getTime();
                return fechaA - fechaB;
            });
            
            if (lotesCache.length === 0) {
                 listaLotesUI.innerHTML = '<p class="text-gray-600">No hay lotes de venta activos.</p>';
                return;
            }


            lotesCache.forEach((lote) => {
                const fechaVenta = new Date(lote.fechaVentaEstimada + 'T00:00:00');
                const fechaInicio = new Date(lote.fechaInicio + 'T00:00:00');
                
                const diasRestantes = Math.ceil((fechaVenta.getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
                
                let colorBorde = 'border-green-500'; 
                if (diasRestantes <= 60) colorBorde = 'border-yellow-500';
                if (diasRestantes <= 30) colorBorde = 'border-red-500';

                const numAnimales = lote.uidsGanado ? lote.uidsGanado.length : 0;
                
                const item = document.createElement('div');
                item.className = `p-4 bg-white border-4 rounded-lg shadow-md item-lote ${colorBorde}`;
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-orange-700">${lote.nombre}</h3>
                        <span class="text-sm font-semibold text-gray-500">ID Lote: ${lote.id.substring(0, 8)}...</span>
                    </div>
                    <p class="mt-1">Duraci√≥n: <strong>${lote.duracionEngorde} meses</strong></p>
                    <p>Iniciado: ${fechaInicio.toLocaleDateString('es-GT')}</p>
                    <p class="text-lg font-semibold text-blue-600">Venta Estimada: ${fechaVenta.toLocaleDateString('es-GT')}</p>
                    
                    <div class="mt-2 p-3 bg-gray-100 rounded">
                        <p class="font-medium">Animales en Lote: <strong>${numAnimales}</strong></p>
                        <p class="text-sm text-gray-600">${numAnimales > 0 ? lote.uidsGanado.join(', ') : 'No hay animales asignados'}</p>
                    </div>
                    
                    <div class="mt-4">
                        <button data-lote-id="${lote.id}" class="btn-eliminar-lote bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            Eliminar Lote
                        </button>
                    </div>
                `;
                listaLotesUI.appendChild(item);
            });
        }
        
        // --- C. CREAR NUEVO LOTE ---
        btnCrearLote.addEventListener('click', async () => {
            const nombre = inputLoteNombre.value.trim();
            const duracion = parseInt(selectLoteDuracion.value);

            if (!nombre) {
                alert("Por favor, ingresa un nombre para el lote.");
                return;
            }
            if (isNaN(duracion) || duracion <= 0) {
                 alert("Error en la duraci√≥n del lote.");
                return;
            }
            
            const fechaInicio = new Date();
            const fechaVentaEstimada = new Date(fechaInicio);
            fechaVentaEstimada.setMonth(fechaVentaEstimada.getMonth() + duracion);
            
            // Formatear la fecha para Firebase (YYYY-MM-DD)
            const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
            const fechaVentaStr = fechaVentaEstimada.toISOString().split('T')[0];
            
            const nuevoLote = {
                nombre: nombre,
                duracionEngorde: duracion,
                fechaInicio: fechaInicioStr,
                fechaVentaEstimada: fechaVentaStr,
                uidsGanado: [] // Lista de UIDs vac√≠a
            };

            try {
                // Firebase asignar√° un ID √∫nico autom√°ticamente al documento
                const lotesRef = collection(db, "lotes_venta");
                await setDoc(doc(lotesRef), nuevoLote); 
                
                alert(`Lote "${nombre}" creado con √©xito. Venta estimada: ${fechaVentaEstimada.toLocaleDateString('es-GT')}`);
                inputLoteNombre.value = ''; // Limpiar campo
                selectLoteDuracion.value = '3';
                // El onSnapshot recarga la lista
            } catch (error) {
                console.error("Error al crear el lote:", error);
                alert("Error al crear el lote.");
            }
        });
        
        // --- D. ELIMINAR LOTE ---
        listaLotesUI.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btn-eliminar-lote')) {
                const loteId = e.target.dataset.loteId;
                const confirmar = confirm(`¬øEst√°s seguro de que quieres eliminar el lote? Los animales NO ser√°n eliminados, pero ya no pertenecer√°n a este lote.`);
                
                if (confirmar) {
                    try {
                        const loteRef = doc(db, "lotes_venta", loteId);
                        await deleteDoc(loteRef);
                        alert("¬°Lote eliminado con √©xito!");
                        // Nota: Faltar√≠a actualizar el campo 'loteId' de los animales que pertenec√≠an a √©l (se har√° en el Paso 3)
                    } catch (error) {
                        console.error("Error al eliminar el lote:", error);
                        alert("Error al eliminar el lote.");
                    }
                }
            }
        });

        // ==================================================================
        // --- FUNCIONES DE RENDERIZADO (Anteriores) ---
        // ==================================================================
        
        // --- RENDERIZAR INVENTARIO GENERAL (igual a v4.15) ---
        function renderizarInventario() {
            inventarioUI.innerHTML = '';
            const filtroSexo = selectFiltroSexo.value;
            const terminoBusqueda = inputBuscador.value.toLowerCase();
            
            let listadoFiltrado = inventarioCache.filter(animal => {
                const nombreUID = (animal.nombre + animal.uid).toLowerCase();
                return (filtroSexo === 'todos' || animal.sexo === filtroSexo) &&
                       (!terminoBusqueda || nombreUID.includes(terminoBusqueda));
            });
            
            listadoFiltrado.forEach((animal) => {
                const animalId = animal.uid; 
                
                const item = document.createElement('div');
                item.id = `vaca-${animalId}`; 
                item.className = 'p-4 bg-white border rounded-lg shadow-sm item-vaca';

                let edadTexto = '';
                if (animal.edadAnos > 0) edadTexto += `${animal.edadAnos} a√±os`;
                if (animal.edadMeses > 0) {
                    if (animal.edadAnos > 0) edadTexto += `, `;
                    edadTexto += `${animal.edadMeses} meses`;
                }
                if (edadTexto === '') edadTexto = `Menos de 1 mes`;


                let htmlCamposExtra = '';
                let colorSexo = animal.sexo === 'hembra' ? 'text-pink-600' : 'text-blue-600';

                if (animal.sexo === 'hembra') {
                    htmlCamposExtra += `<p>Partos: ${animal.partos}</p>`;

                    if (animal.embarazada) {
                        htmlCamposExtra += `<p>Embarazada: <strong class="text-green-600">S√≠</strong></p>`;
                        if (animal.estimadaParto) {
                            const fechaEstimada = new Date(animal.estimadaParto + 'T00:00:00');
                            htmlCamposExtra += `<p class="font-medium text-blue-700">F. Estimada Parto: ${fechaEstimada.toLocaleDateString('es-GT')}</p>`;
                        }
                    } else {
                        htmlCamposExtra += `<p>Embarazada: No</p>`;
                    }
                } else if (animal.sexo === 'macho') {
                    htmlCamposExtra += `<p>Estado: <strong>${animal.estadoMacho === 'reproduccion' ? 'Reproducci√≥n' : 'Venta / Engorde'}</strong></p>`;
                    
                    // Bot√≥n para asignar a lote, visible si es Macho en Venta
                    if (animal.estadoMacho === 'venta') {
                        htmlCamposExtra += `
                            <div class="mt-2">
                                <button data-uid="${animalId}" class="btn-asignar-lote bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                    Asignar a Lote
                                </button>
                            </div>
                        `;
                    }
                }

                
                item.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-700">${animal.nombre} (UID: <span class="font-mono">${animal.uid}</span>)</h3>
                    <p>Sexo: <strong class="${colorSexo}">${animal.sexo.toUpperCase()}</strong></p>
                    <p>Edad: ${edadTexto}</p>
                    <p>Peso: ${animal.peso} kg</p>
                    
                    ${htmlCamposExtra} 
                    
                    <div class="mt-2">
                        <button data-uid="${animalId}" class="btn-editar bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                            Editar
                        </button>
                        <button data-uid="${animalId}" class="btn-eliminar bg-red-500 text-white px-3 py-1 rounded text-sm">
                            Eliminar
                        </button>
                    </div>
                `;
                inventarioUI.appendChild(item);
            });
        }
        
        // --- RENDERIZAR PRON√ìSTICO DE PARTOS (igual a v4.15) ---
        function renderizarPronosticoPartos() {
            listaPronosticoUI.innerHTML = '';
            cargandoPronosticoUI.style.display = 'none';

            let listadoPartos = inventarioCache.filter(animal => 
                animal.sexo === 'hembra' && animal.embarazada && animal.estimadaParto
            );
            
            listadoPartos.sort((a, b) => {
                const fechaA = new Date(a.estimadaParto).getTime();
                const fechaB = new Date(b.estimadaParto).getTime();
                return fechaA - fechaB;
            });
            
            if (listadoPartos.length === 0) {
                listaPronosticoUI.innerHTML = '<p class="text-gray-600">No hay hembras pre√±adas registradas con fecha estimada de parto.</p>';
                return;
            }

            listadoPartos.forEach((animal) => {
                const fechaEstimada = new Date(animal.estimadaParto + 'T00:00:00');
                const fechaHoy = new Date();
                
                const diferenciaTiempo = fechaEstimada.getTime() - fechaHoy.getTime();
                const diasRestantes = Math.ceil(diferenciaTiempo / (1000 * 60 * 60 * 24));
                
                let colorClase = 'bg-green-100 border-green-400';
                if (diasRestantes <= 30) colorClase = 'bg-red-100 border-red-500 font-bold';
                else if (diasRestantes <= 60) colorClase = 'bg-yellow-100 border-yellow-500';

                const item = document.createElement('div');
                item.className = `p-4 border-l-4 rounded shadow-md ${colorClase}`;
                item.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800">${animal.nombre} (UID: ${animal.uid})</h3>
                    <p class="mt-1">Parto Estimado: <strong class="text-lg">${fechaEstimada.toLocaleDateString('es-GT')}</strong></p>
                    <p>D√≠as restantes: <strong class="text-lg">${diasRestantes > 0 ? diasRestantes : '¬°Parto inminente!'}</strong></p>
                    <button data-uid="${animal.uid}" class="btn-editar bg-blue-600 text-white px-3 py-1 mt-2 rounded text-sm hover:bg-blue-700">
                        Ver / Editar
                    </button>
                `;
                listaPronosticoUI.appendChild(item);
            });
        }
        
        // --- FUNCI√ìN PARA ABRIR EL FORMULARIO DE EDICI√ìN (igual a v4.15) ---
        async function abrirFormularioEdicion(uid) {
            try {
                const animalRef = doc(db, "ganado", uid);
                const animalSnap = await getDoc(animalRef);

                if (!animalSnap.exists()) {
                    alert("Error: No se encontr√≥ el animal para editar.");
                    return;
                }

                const animal = animalSnap.data();
                mostrarFormulario(animal.uid, null); 
                
                selectSexo.value = animal.sexo;
                document.getElementById('form-nombre').value = animal.nombre || '';
                document.getElementById('form-peso').value = animal.peso || 0;
                document.getElementById('form-edad-anos').value = animal.edadAnos || 0;
                document.getElementById('form-edad-meses').value = animal.edadMeses || 0;
                
                if (animal.sexo === 'hembra') {
                    camposHembraUI.classList.remove('hidden');
                    campoEstadoMacho.classList.add('hidden');
                    inputPartos.value = animal.partos || 0;
                    selectEmbarazada.value = animal.embarazada ? 'true' : 'false';
                    inputUltimoParto.value = animal.ultimoParto || '';
                    inputFechaEstimada.value = animal.estimadaParto || '';

                    if (animal.embarazada) {
                        campoFechaEstimada.classList.remove('hidden');
                    } else {
                        campoFechaEstimada.classList.add('hidden');
                    }
                } else if (animal.sexo === 'macho') {
                    camposHembraUI.classList.add('hidden');
                    campoEstadoMacho.classList.remove('hidden');
                    selectEstadoMacho.value = animal.estadoMacho || 'reproduccion';
                }

            } catch (error) {
                console.error("Error al cargar datos para editar:", error);
                alert("No se pudieron cargar los datos del ganado.");
            }
        }

        // --- L√ìGICA PARA ELIMINAR Y EDITAR (Combinada para todas las listas) ---
        const todasLasListas = [inventarioUI, listaPronosticoUI, listaLotesUI];

        todasLasListas.forEach(lista => {
            lista.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btn-eliminar')) {
                    const uid = e.target.dataset.uid;
                    const confirmar = confirm(`¬øEst√°s seguro de que quieres eliminar este animal con UID: ${uid}? Esta acci√≥n no se puede deshacer.`);
                    
                    if (confirmar) {
                        try {
                            const animalRef = doc(db, "ganado", uid);
                            await deleteDoc(animalRef);
                            alert("¬°Ganado eliminado con √©xito!");
                        } catch (error) {
                            console.error("Error al eliminar el animal:", error);
                            alert("Error al eliminar el animal.");
                        }
                    }
                }

                if (e.target.classList.contains('btn-editar')) {
                    const uid = e.target.dataset.uid;
                    await abrirFormularioEdicion(uid);
                }
                
                // --- NUEVO: ASIGNAR A LOTE (Sub-paso 2.1) ---
                if (e.target.classList.contains('btn-asignar-lote')) {
                    const uid = e.target.dataset.uid;
                    asignarAMachoVenta(uid);
                }
            });
        });
        
        // --- FUNCI√ìN TEMPORAL PARA ASIGNAR A LOTE (Se mejorar√° en el Paso 3) ---
        function asignarAMachoVenta(uid) {
            if (lotesCache.length === 0) {
                alert("No hay lotes de venta creados. Por favor, crea un lote primero en la pesta√±a 'Lotes de Venta'.");
                return;
            }
            
            // L√≥gica simple: si hay lotes, ir a la pesta√±a de lotes para elegir (lo automatizaremos en el paso siguiente)
            alert(`Animal ${uid} listo para ser asignado. Debes ir a la pesta√±a 'Lotes de Venta' y elegir a cu√°l lote pertenece.`);
            // Para el Paso 3: mostraremos un modal con la lista de lotes para que elijas.
        }

        // --- L√ìGICA DEL BUSCADOR Y FILTROS ---
        inputBuscador.addEventListener('input', renderizarInventario);
        selectFiltroSexo.addEventListener('change', renderizarInventario);

        // --- INICIAR TODO ---
        iniciarSistema();

    </script>

</body>
</html>