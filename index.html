<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ganado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes highlight-flash {
            0% { background-color: white; }
            30% { background-color: #dbeafe; }
            100% { background-color: white; }
        }
        
        .highlight-animation {
            animation: highlight-flash 2s ease-out;
        }
    </style>

</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">

        <h1 class="text-3xl font-bold text-blue-800 mb-6">Gestor de Ganado</h1>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Escaneos Pendientes por Registrar</h2>
            <p id="cargando-pendientes" class="text-gray-500">Iniciando...</p>
            <ul id="lista-pendientes" class="space-y-2">
                </ul>
        </div>

        <hr class="my-8">

        <div id="formulario-registro" class="hidden bg-blue-50 p-6 rounded-lg">
            <h2 id="formulario-titulo" class="text-2xl font-semibold mb-4">Registrar Ganado</h2>
            
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">UID</label>
                    <input type="text" id="form-uid" readonly class="mt-1 block w-full p-2 bg-gray-200 border-gray-300 rounded-md shadow-sm">
                    <input type="hidden" id="form-scan-id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre / Identificador</label>
                    <input type="text" id="form-nombre" placeholder="Ej: Manchitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sexo</label>
                    <select id="form-sexo" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="hembra">Hembra</option>
                        <option value="macho">Macho</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Edad (años)</label>
                    <input type="number" id="form-edad-anos" value="0" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Edad (meses)</label>
                    <input type="number" id="form-edad-meses" value="0" min="0" max="11" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                    <input type="number" id="form-peso" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>

            <div id="campos-hembra" class="grid grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Número de Partos</label>
                    <input type="number" id="form-partos" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">¿Embarazada?</label>
                    <select id="form-embarazada" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="false">No</option>
                        <option value="true">Sí</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha del último parto</label>
                    <input type="date" id="form-ultimo-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div id="campo-fecha-estimada" class="hidden col-span-1">
                    <label class="block text-sm font-medium text-gray-700">Fecha estimada del parto</label>
                    <input type="date" id="form-estimada-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button id="btn-guardar" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar Ganado</button>
                <button id="btn-cancelar" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
            </div>
        </div>

        <hr class="my-8">

        <div>
            <h2 class="text-2xl font-semibold mb-4">Mi Inventario de Ganado</h2>
            
            <div class="mb-4">
                <label for="input-buscador" class="block text-sm font-medium text-gray-700">Buscar por nombre:</label>
                <input type="text" id="input-buscador" placeholder="Escribe un nombre..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
            </div>

            <p id="cargando-inventario" class="text-gray-500">Iniciando...</p>
            <div id="lista-inventario" class="space-y-4">
                </div>
        </div>

    </div>

    <script type="module">
        // Importamos solo las funciones que necesitamos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, 
            setDoc, deleteDoc, getDocs, query,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        import { 
            getAuth, 
            signInWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";


        // --- 1. CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFeLhhCLU2TUQUJjG8IsfUG3JBTc-xyTM",
            authDomain: "proyectocorralpin.firebaseapp.com",
            projectId: "proyectocorralpin",
            storageBucket: "proyectocorralpin.appspot.com",
            messagingSenderId: "1058204128531",
            appId: "1:1058204128531:web:dd88871038c1a7c3e5362a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias a los elementos del HTML
        const listaPendientesUI = document.getElementById('lista-pendientes');
        const cargandoPendientesUI = document.getElementById('cargando-pendientes');
        const formularioUI = document.getElementById('formulario-registro');
        const formularioTituloUI = document.getElementById('formulario-titulo');
        const btnGuardar = document.getElementById('btn-guardar');
        const btnCancelar = document.getElementById('btn-cancelar');
        const inventarioUI = document.getElementById('lista-inventario');
        const cargandoInventarioUI = document.getElementById('cargando-inventario');
        const selectEmbarazada = document.getElementById('form-embarazada');
        const campoFechaEstimada = document.getElementById('campo-fecha-estimada');
        const inputUltimoParto = document.getElementById('form-ultimo-parto');
        const inputFechaEstimada = document.getElementById('form-estimada-parto');
        const inputBuscador = document.getElementById('input-buscador');
        
        // ¡NUEVOS! Elementos del formulario
        const selectSexo = document.getElementById('form-sexo');
        const camposHembraUI = document.getElementById('campos-hembra');
        const inputPartos = document.getElementById('form-partos');


        let uidsDeGanado = new Set();


        // --- FUNCIÓN DE INICIO (Autenticación) ---
        async function iniciarSistema() {
            try {
                console.log("Autenticando la página web...");
                cargandoPendientesUI.innerText = "Autenticando...";
                cargandoInventarioUI.innerText = "Autenticando...";
                
                await signInWithEmailAndPassword(auth, "enndels@gmail.com", "123456789");
                console.log("¡Página web autenticada con éxito!");

                await cargarInventario();
                escucharEscaneosPendientes();

            } catch (error) {
                console.error("¡Error fatal al autenticar la página!", error.code, error.message);
                cargandoPendientesUI.innerText = "Error de autenticación.";
                cargandoInventarioUI.innerText = "Error de autenticación.";
            }
        }


        // --- ESCUCHAR ESCANEOS PENDIENTES (v4.11) ---
        function escucharEscaneosPendientes() {
            const scansRef = collection(db, "public_scans");
            
            onSnapshot(scansRef, (snapshot) => {
                
                let hayPendientes = false;

                snapshot.docs.forEach(async (doc) => {
                    const scan = doc.data();
                    const scanId = doc.id; 
                    
                    if (uidsDeGanado.has(scan.uid)) {
                        // --- CASO B: VACA REPETIDA ---
                        console.log(`Ganado existente detectado: ${scan.uid}`);
                        
                        const vacaCard = document.getElementById(`vaca-${scan.uid}`);
                        if (vacaCard) {
                            vacaCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            vacaCard.classList.add('highlight-animation');
                            setTimeout(() => {
                                vacaCard.classList.remove('highlight-animation');
                            }, 2000);
                        }
                        
                        const scanRef = doc(db, "public_scans", scanId);
                        await deleteDoc(scanRef);

                    } else {
                        // --- CASO A: GANADO NUEVO ---
                        hayPendientes = true;
                        
                        let timestampStr = "Fecha desconocida";
                        if (scan.timestamp) {
                            timestampStr = new Date(scan.timestamp).toLocaleString('es-GT');
                        }

                        const item = document.createElement('li');
                        item.className = "flex justify-between items-center p-3 bg-gray-50 rounded shadow-sm";
                        item.innerHTML = `
                            <span>UID: <strong class="font-mono">${scan.uid}</strong> (Escaneado: ${timestampStr})</span>
                            <button data-uid="${scan.uid}" data-scan-id="${scanId}" class="btn-registrar bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                Registrar
                            </button>
                        `;
                        listaPendientesUI.appendChild(item);
                    }
                }); // Fin del forEach

                if (!hayPendientes) {
                    cargandoPendientesUI.innerText = "No hay escaneos pendientes.";
                    listaPendientesUI.innerHTML = '';
                } else {
                    cargandoPendientesUI.style.display = 'none';
                }
            });
        }


        // --- LÓGICA DEL FORMULARIO --- 
        
        // Función para limpiar y mostrar el formulario
        function mostrarFormulario(uid, scanId) {
            formularioTituloUI.innerText = scanId ? "Registrar Nuevo Ganado" : "Editar Ganado";
            document.getElementById('form-uid').value = uid;
            document.getElementById('form-scan-id').value = scanId || '';
            
            // Limpiar campos generales
            document.getElementById('form-nombre').value = '';
            document.getElementById('form-peso').value = '';
            document.getElementById('form-edad-anos').value = 0;
            document.getElementById('form-edad-meses').value = 0;
            selectSexo.value = 'hembra'; // Valor por defecto
            
            // Limpiar campos de hembra
            inputPartos.value = 0;
            selectEmbarazada.value = 'false';
            inputUltimoParto.value = '';
            inputFechaEstimada.value = '';
            
            // Mostrar campos de hembra por defecto y ocultar fecha estimada
            camposHembraUI.classList.remove('hidden');
            campoFechaEstimada.classList.add('hidden');
            
            formularioUI.classList.remove('hidden');
            formularioUI.scrollIntoView({ behavior: 'smooth' });
        }


        // Mostrar formulario al hacer clic en "Registrar"
        listaPendientesUI.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-registrar')) {
                mostrarFormulario(e.target.dataset.uid, e.target.dataset.scanId);
            }
        });

        // Ocultar formulario al hacer clic en "Cancelar"
        btnCancelar.addEventListener('click', () => {
            formularioUI.classList.add('hidden');
        });

        // Mostrar/Ocultar "Fecha Estimada Parto"
        selectEmbarazada.addEventListener('change', (e) => {
            if (e.target.value === 'true') {
                campoFechaEstimada.classList.remove('hidden');
            } else {
                campoFechaEstimada.classList.add('hidden');
                inputFechaEstimada.value = '';
            }
        });

        // --- ¡NUEVO! Lógica para ocultar/mostrar campos según el Sexo ---
        selectSexo.addEventListener('change', (e) => {
            if (e.target.value === 'macho') {
                camposHembraUI.classList.add('hidden');
            } else {
                camposHembraUI.classList.remove('hidden');
            }
        });


        // ==================================================================
        // --- LÓGICA DE GUARDADO (¡MODIFICADA v4.13!) ---
        // ==================================================================
        btnGuardar.addEventListener('click', async () => {
            const uid = document.getElementById('form-uid').value;
            const scanId = document.getElementById('form-scan-id').value; 
            
            // Datos generales
            const nombre = document.getElementById('form-nombre').value;
            const sexo = selectSexo.value;
            const peso = parseInt(document.getElementById('form-peso').value) || 0;
            
            // Datos de edad
            const edadAnos = parseInt(document.getElementById('form-edad-anos').value) || 0;
            const edadMeses = parseInt(document.getElementById('form-edad-meses').value) || 0;
            
            const edadTotalMeses = (edadAnos * 12) + edadMeses;
            const edadDecimal = edadAnos + (edadMeses / 12); // Para display/cálculos

            // Datos de hembra (Inicialmente vacíos o cero)
            let partos = 0;
            let estaEmbarazada = false;
            let ultimoParto = null;
            let estimadaParto = null;


            // --- VALIDACIONES INICIALES ---
            if (!nombre || !uid) {
                alert("Error: El UID o el Nombre están vacíos.");
                return;
            }
            if (peso <= 0) {
                 alert("Error: El peso debe ser un número positivo.");
                return;
            }
            if (edadTotalMeses < 0) {
                alert("Error: La edad no puede ser negativa.");
                return;
            }
            if (edadAnos > 18) { // Validación de Edad Máxima (en años)
                alert("Error: La edad no puede ser mayor a 18 años.");
                return;
            }
            // --- FIN VALIDACIONES INICIALES ---

            
            // --- LÓGICA Y VALIDACIONES ESPECÍFICAS PARA HEMBRAS ---
            if (sexo === 'hembra') {
                partos = parseInt(inputPartos.value) || 0;
                estaEmbarazada = selectEmbarazada.value === 'true';
                ultimoParto = inputUltimoParto.value || null;
                estimadaParto = estaEmbarazada ? (inputFechaEstimada.value || null) : null;

                // 1. Validación de Partos vs Edad (usando años)
                if (partos > edadAnos) { 
                    alert("Error: El número de partos no puede ser mayor que la edad en años.");
                    return; 
                }
                
                // 2. Validación de Edad Mínima para Embarazo (1 año o 12 meses)
                if (estaEmbarazada && edadTotalMeses < 12) {
                    alert("Error: Una hembra debe tener al menos 1 año (12 meses) para estar registrada como embarazada.");
                    return;
                }
            }


            // Creamos el objeto final (incluyendo los campos de hembra, que serán null/0 para machos)
            const datosGanado = {
                uid: uid,
                nombre: nombre, 
                sexo: sexo,
                peso: peso,
                // Almacenamos la edad en años, meses y el decimal para el display
                edadAnos: edadAnos,
                edadMeses: edadMeses,
                edadDecimal: parseFloat(edadDecimal.toFixed(2)),
                
                // Campos específicos de hembra
                partos: partos,
                embarazada: estaEmbarazada,
                ultimoParto: ultimoParto, 
                estimadaParto: estimadaParto
            };

            
            try {
                const ganadoRef = doc(db, "ganado", uid);
                await setDoc(ganadoRef, datosGanado, { merge: true });

                if (scanId) {
                    uidsDeGanado.add(uid);
                    
                    const scanRef = doc(db, "public_scans", scanId);
                    await deleteDoc(scanRef);
                    alert("¡Ganado registrado con éxito!");
                } else {
                    alert("¡Ganado actualizado con éxito!");
                }
                
                formularioUI.classList.add('hidden');
                await cargarInventario(); 

            } catch (error) {
                console.error("Error al guardar:", error);
                alert("Error al guardar el ganado.");
            }
        });

        // --- CARGAR INVENTARIO GENERAL (¡MODIFICADO v4.13!) --- 
        async function cargarInventario() {
            inventarioUI.innerHTML = '';
            cargandoInventarioUI.innerText = 'Cargando inventario...';
            
            uidsDeGanado.clear();
            
            const querySnapshot = await getDocs(collection(db, "ganado"));
            
            if (querySnapshot.empty) {
                cargandoInventarioUI.innerText = 'Aún no hay ganado registrado.';
                return;
            }

            cargandoInventarioUI.style.display = 'none';

            querySnapshot.forEach((doc) => {
                const animal = doc.data();
                const animalId = doc.id; 
                
                uidsDeGanado.add(animalId);
                
                const item = document.createElement('div');
                item.id = `vaca-${animalId}`; 
                item.className = 'p-4 bg-white border rounded-lg shadow-sm item-vaca';

                // Formateo de Edad (ej: 2 años, 6 meses)
                let edadTexto = '';
                if (animal.edadAnos > 0) edadTexto += `${animal.edadAnos} años`;
                if (animal.edadMeses > 0) {
                    if (animal.edadAnos > 0) edadTexto += `, `;
                    edadTexto += `${animal.edadMeses} meses`;
                }
                if (edadTexto === '') edadTexto = `Menos de 1 mes`;


                // Lógica y Display para HEMBRAS
                let htmlCamposExtra = '';
                if (animal.sexo === 'hembra') {
                    htmlCamposExtra += `<p>Partos: ${animal.partos}</p>`;

                    if (animal.ultimoParto) {
                        const fechaUltimoParto = new Date(animal.ultimoParto + 'T00:00:00');
                        htmlCamposExtra += `<p class="mt-2">Último Parto: ${fechaUltimoParto.toLocaleDateString('es-GT')}</p>`;
                    }
                    
                    if (animal.embarazada) {
                        htmlCamposExtra += `<p>Embarazada: <strong class="text-green-600">Sí</strong></p>`;
                        
                        if (animal.estimadaParto) {
                            const fechaEstimada = new Date(animal.estimadaParto + 'T00:00:00');
                            htmlCamposExtra += `<p class="font-medium text-blue-700">Fecha Estimada Parto: ${fechaEstimada.toLocaleDateString('es-GT')}</p>`;

                            const proximaOptimaPreño = new Date(fechaEstimada);
                            proximaOptimaPreño.setDate(proximaOptimaPreño.getDate() + 60);
                            htmlCamposExtra += `<p class="font-medium text-purple-700">Fecha Óptima Próx. Ciclo: ${proximaOptimaPreño.toLocaleDateString('es-GT')}</p>`;
                        }

                    } else {
                        htmlCamposExtra += `<p>Embarazada: No</p>`;
                        if (animal.ultimoParto) {
                            const fechaUltimoParto = new Date(animal.ultimoParto + 'T00:00:00');
                            const fechaOptima = new Date(fechaUltimoParto);
                            fechaOptima.setDate(fechaOptima.getDate() + 60); 
                            
                            htmlCamposExtra += `<p class="font-medium text-green-700">Fecha Óptima Preño: ${fechaOptima.toLocaleDateString('es-GT')}</p>`;
                        }
                    }
                } // Fin lógica de hembras

                
                item.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-700">${animal.nombre} (UID: <span class="font-mono">${animal.uid}</span>)</h3>
                    <p>Sexo: <strong>${animal.sexo.toUpperCase()}</strong></p>
                    <p>Edad: ${edadTexto}</p>
                    <p>Peso: ${animal.peso} kg</p>
                    
                    ${htmlCamposExtra} 
                    
                    <div class="mt-2">
                        <button data-uid="${animalId}" class="btn-editar bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                            Editar
                        </button>
                        <button data-uid="${animalId}" class="btn-eliminar bg-red-500 text-white px-3 py-1 rounded text-sm">
                            Eliminar
                        </button>
                    </div>
                `;
                inventarioUI.appendChild(item);
            });
        }
        
        // --- FUNCIÓN PARA ABRIR EL FORMULARIO DE EDICIÓN (¡MODIFICADO v4.13!) ---
        async function abrirFormularioEdicion(uid) {
            try {
                console.log(`Abriendo edición para: ${uid}`);
                const animalRef = doc(db, "ganado", uid);
                const animalSnap = await getDoc(animalRef);

                if (!animalSnap.exists()) {
                    alert("Error: No se encontró el animal para editar.");
                    return;
                }

                const animal = animalSnap.data();

                mostrarFormulario(animal.uid, null); // Reutilizamos la función para limpiar
                
                // Cargar datos generales
                selectSexo.value = animal.sexo;
                document.getElementById('form-nombre').value = animal.nombre || '';
                document.getElementById('form-peso').value = animal.peso || 0;
                document.getElementById('form-edad-anos').value = animal.edadAnos || 0;
                document.getElementById('form-edad-meses').value = animal.edadMeses || 0;


                // Cargar y mostrar/ocultar campos de hembra
                if (animal.sexo === 'hembra') {
                    camposHembraUI.classList.remove('hidden');
                    inputPartos.value = animal.partos || 0;
                    selectEmbarazada.value = animal.embarazada ? 'true' : 'false';
                    inputUltimoParto.value = animal.ultimoParto || '';
                    inputFechaEstimada.value = animal.estimadaParto || '';

                    if (animal.embarazada) {
                        campoFechaEstimada.classList.remove('hidden');
                    } else {
                        campoFechaEstimada.classList.add('hidden');
                    }
                } else {
                    camposHembraUI.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error al cargar datos para editar:", error);
                alert("No se pudieron cargar los datos del ganado.");
            }
        }


        // --- LÓGICA DEL BUSCADOR ---
        inputBuscador.addEventListener('input', (e) => {
            const terminoBusqueda = e.target.value.toLowerCase();
            const itemsVaca = inventarioUI.querySelectorAll('.item-vaca'); 
            
            itemsVaca.forEach(item => {
                const nombreVaca = item.querySelector('h3').textContent.toLowerCase();
                
                if (nombreVaca.includes(terminoBusqueda)) {
                    item.style.display = 'block'; 
                } else {
                    item.style.display = 'none'; 
                }
            });
        });

        // --- LÓGICA PARA ELIMINAR Y EDITAR ---
        inventarioUI.addEventListener('click', async (e) => {
            
            if (e.target.classList.contains('btn-eliminar')) {
                const uid = e.target.dataset.uid;
                const confirmar = confirm(`¿Estás seguro de que quieres eliminar este animal con UID: ${uid}? Esta acción no se puede deshacer.`);
                
                if (confirmar) {
                    try {
                        console.log(`Eliminando animal: ${uid}`);
                        const animalRef = doc(db, "ganado", uid);
                        await deleteDoc(animalRef);

                        uidsDeGanado.delete(uid);
                        
                        alert("¡Ganado eliminado con éxito!");
                        await cargarInventario(); 
                        
                    } catch (error) {
                        console.error("Error al eliminar el animal:", error);
                        alert("Error al eliminar el animal.");
                    }
                }
            }

            if (e.target.classList.contains('btn-editar')) {
                const uid = e.target.dataset.uid;
                await abrirFormularioEdicion(uid);
            }
        });

        // --- INICIAR TODO ---
        iniciarSistema();

    </script>

</body>
</html>