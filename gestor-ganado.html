<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Ganado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Animación de "flash" o "parpadeo" */
        @keyframes highlight-flash {
            0% { background-color: white; }
            30% { background-color: #dbeafe; } /* Un azul muy claro */
            100% { background-color: white; }
        }
        
        .highlight-animation {
            animation: highlight-flash 2s ease-out;
        }
    </style>

</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">

        <h1 class="text-3xl font-bold text-blue-800 mb-6">Gestor de Ganado</h1>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold mb-4">Escaneos Pendientes por Registrar</h2>
            <p id="cargando-pendientes" class="text-gray-500">Iniciando...</p>
            <ul id="lista-pendientes" class="space-y-2">
                </ul>
        </div>

        <hr class="my-8">

        <div id="formulario-registro" class="hidden bg-blue-50 p-6 rounded-lg">
            <h2 id="formulario-titulo" class="text-2xl font-semibold mb-4">Registrar Nueva Vaca</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">UID</label>
                    <input type="text" id="form-uid" readonly class="mt-1 block w-full p-2 bg-gray-200 border-gray-300 rounded-md shadow-sm">
                    <input type="hidden" id="form-scan-id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre / Identificador</label>
                    <input type="text" id="form-nombre" placeholder="Ej: Manchitas" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Edad (años)</label>
                    <input type="number" id="form-edad" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Número de Partos</label>
                    <input type="number" id="form-partos" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">¿Embarazada?</label>
                    <select id="form-embarazada" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="false">No</option>
                        <option value="true">Sí</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha del último parto</label>
                    <input type="date" id="form-ultimo-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div id="campo-fecha-estimada" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Fecha estimada del parto</label>
                    <input type="date" id="form-estimada-parto" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>

            <div class="mt-6 flex gap-4">
                <button id="btn-guardar" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Guardar Vaca</button>
                <button id="btn-cancelar" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancelar</button>
            </div>
        </div>

        <hr class="my-8">

        <div>
            <h2 class="text-2xl font-semibold mb-4">Mi Inventario de Ganado</h2>
            
            <div class="mb-4">
                <label for="input-buscador" class="block text-sm font-medium text-gray-700">Buscar por nombre:</label>
                <input type="text" id="input-buscador" placeholder="Escribe un nombre..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
            </div>

            <p id="cargando-inventario" class="text-gray-500">Iniciando...</p>
            <div id="lista-inventario" class="space-y-4">
                </div>
        </div>

    </div>

    <script type="module">
        // Importamos solo las funciones que necesitamos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, onSnapshot, doc, 
            setDoc, deleteDoc, getDocs, query,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        import { 
            getAuth, 
            signInWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";


        // --- 1. CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBFeLhhCLU2TUQUJjG8IsfUG3JBTc-xyTM",
            authDomain: "proyectocorralpin.firebaseapp.com",
            projectId: "proyectocorralpin",
            storageBucket: "proyectocorralpin.appspot.com",
            messagingSenderId: "1058204128531",
            appId: "1:1058204128531:web:dd88871038c1a7c3e5362a"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Referencias a los elementos del HTML
        const listaPendientesUI = document.getElementById('lista-pendientes');
        const cargandoPendientesUI = document.getElementById('cargando-pendientes');
        const formularioUI = document.getElementById('formulario-registro');
        const formularioTituloUI = document.getElementById('formulario-titulo');
        const btnGuardar = document.getElementById('btn-guardar');
        const btnCancelar = document.getElementById('btn-cancelar');
        const inventarioUI = document.getElementById('lista-inventario');
        const cargandoInventarioUI = document.getElementById('cargando-inventario');
        const selectEmbarazada = document.getElementById('form-embarazada');
        const campoFechaEstimada = document.getElementById('campo-fecha-estimada');
        const inputFechaEstimada = document.getElementById('form-estimada-parto');
        const inputUltimoParto = document.getElementById('form-ultimo-parto');
        const inputBuscador = document.getElementById('input-buscador');

        // --- ¡NUEVO! "Memoria" para guardar los UIDs del inventario ---
        let uidsDeGanado = new Set();


        // --- FUNCIÓN DE INICIO (Autenticación) ---
        async function iniciarSistema() {
            try {
                console.log("Autenticando la página web...");
                cargandoPendientesUI.innerText = "Autenticando...";
                cargandoInventarioUI.innerText = "Autenticando...";
                
                await signInWithEmailAndPassword(auth, "enndels@gmail.com", "123456789");
                console.log("¡Página web autenticada con éxito!");

                // ¡IMPORTANTE! Cargamos el inventario PRIMERO
                // para llenar nuestra "memoria" de UIDs.
                await cargarInventario();
                
                // SOLO DESPUÉS de cargar el inventario, 
                // empezamos a escuchar los nuevos escaneos.
                escucharEscaneosPendientes();

            } catch (error) {
                console.error("¡Error fatal al autenticar la página!", error.code, error.message);
                cargandoPendientesUI.innerText = "Error de autenticación.";
                cargandoInventarioUI.innerText = "Error de autenticación.";
            }
        }


        // ==================================================================
        // --- ESCUCHAR ESCANEOS PENDIENTES (¡MODIFICADO v4.11!) ---
        // ==================================================================
        function escucharEscaneosPendientes() {
            const scansRef = collection(db, "public_scans");
            
            // Este 'oyente' se activa cada vez que algo se AÑADE a 'public_scans'
            onSnapshot(scansRef, (snapshot) => {
                
                let hayPendientes = false;

                snapshot.docs.forEach(async (doc) => {
                    const scan = doc.data();
                    const scanId = doc.id; // ID del documento en 'public_scans'
                    
                    // --- ¡NUEVA LÓGICA INTELIGENTE! ---
                    // Comprobamos si el UID escaneado YA está en nuestra "memoria"
                    if (uidsDeGanado.has(scan.uid)) {
                        // --- CASO B: VACA REPETIDA ---
                        console.log(`Vaca existente detectada: ${scan.uid}`);
                        
                        // 1. Encontrar la tarjeta de la vaca en el inventario
                        const vacaCard = document.getElementById(`vaca-${scan.uid}`);
                        if (vacaCard) {
                            // 2. Desplazarse a la tarjeta
                            vacaCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            
                            // 3. Aplicar la animación de resaltado
                            vacaCard.classList.add('highlight-animation');
                            
                            // 4. Quitar la clase de animación después de 2 segundos
                            setTimeout(() => {
                                vacaCard.classList.remove('highlight-animation');
                            }, 2000);
                        }
                        
                        // 5. Borrar el escaneo de 'public_scans' (ya lo procesamos)
                        const scanRef = doc(db, "public_scans", scanId);
                        await deleteDoc(scanRef);

                    } else {
                        // --- CASO A: VACA NUEVA ---
                        // Esta vaca no está en el inventario, así que la mostramos
                        // en la lista de "Pendientes".
                        hayPendientes = true;
                        
                        let timestampStr = "Fecha desconocida";
                        if (scan.timestamp) {
                            timestampStr = new Date(scan.timestamp).toLocaleString('es-GT');
                        }

                        const item = document.createElement('li');
                        item.className = "flex justify-between items-center p-3 bg-gray-50 rounded shadow-sm";
                        item.innerHTML = `
                            <span>UID: <strong class="font-mono">${scan.uid}</strong> (Escaneado: ${timestampStr})</span>
                            <button data-uid="${scan.uid}" data-scan-id="${scanId}" class="btn-registrar bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                Registrar
                            </button>
                        `;
                        listaPendientesUI.appendChild(item);
                    }
                }); // Fin del forEach

                // Limpieza final de la UI de "Pendientes"
                if (!hayPendientes) {
                    cargandoPendientesUI.innerText = "No hay escaneos pendientes.";
                    listaPendientesUI.innerHTML = '';
                } else {
                    cargandoPendientesUI.style.display = 'none';
                }
            });
        }


        // --- LÓGICA DEL FORMULARIO --- 
        
        // Mostrar formulario al hacer clic en "Registrar"
        listaPendientesUI.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-registrar')) {
                formularioTituloUI.innerText = "Registrar Nueva Vaca";
                document.getElementById('form-uid').value = e.target.dataset.uid;
                document.getElementById('form-scan-id').value = e.target.dataset.scanId;
                
                document.getElementById('form-nombre').value = '';
                document.getElementById('form-edad').value = '';
                document.getElementById('form-partos').value = '';
                selectEmbarazada.value = 'false';
                inputUltimoParto.value = '';
                inputFechaEstimada.value = '';
                
                campoFechaEstimada.classList.add('hidden');
                formularioUI.classList.remove('hidden');
                formularioUI.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Ocultar formulario al hacer clic en "Cancelar"
        btnCancelar.addEventListener('click', () => {
            formularioUI.classList.add('hidden');
        });

        // Mostrar/Ocultar "Fecha Estimada Parto"
        selectEmbarazada.addEventListener('change', (e) => {
            if (e.target.value === 'true') {
                campoFechaEstimada.classList.remove('hidden');
            } else {
                campoFechaEstimada.classList.add('hidden');
                inputFechaEstimada.value = '';
            }
        });

        // LÓGICA DE GUARDADO
        btnGuardar.addEventListener('click', async () => {
            const uid = document.getElementById('form-uid').value;
            const scanId = document.getElementById('form-scan-id').value; 
            const estaEmbarazada = selectEmbarazada.value === 'true';
            
            const datosVaca = {
                uid: uid,
                nombre: document.getElementById('form-nombre').value,
                edad: parseInt(document.getElementById('form-edad').value) || 0,
                partos: parseInt(document.getElementById('form-partos').value) || 0,
                embarazada: estaEmbarazada,
                ultimoParto: inputUltimoParto.value || null, 
                estimadaParto: estaEmbarazada ? (inputFechaEstimada.value || null) : null
            };

            if (!datosVaca.nombre || !uid) {
                alert("Error: El UID o el Nombre están vacíos.");
                return;
            }

            try {
                const vacaRef = doc(db, "ganado", uid);
                await setDoc(vacaRef, datosVaca, { merge: true });

                if (scanId) {
                    // --- ¡NUEVO! Añadir el UID a la "memoria" ---
                    uidsDeGanado.add(uid);
                    
                    const scanRef = doc(db, "public_scans", scanId);
                    await deleteDoc(scanRef);
                    alert("¡Vaca registrada con éxito!");
                } else {
                    alert("¡Vaca actualizada con éxito!");
                }
                
                formularioUI.classList.add('hidden');
                await cargarInventario(); // Usamos await para asegurar que la "memoria" esté actualizada

            } catch (error) {
                console.error("Error al guardar:", error);
                alert("Error al guardar la vaca.");
            }
        });

        // ==================================================================
        // --- CARGAR INVENTARIO GENERAL (¡MODIFICADO v4.11!) --- 
        // ==================================================================
        async function cargarInventario() {
            inventarioUI.innerHTML = '';
            cargandoInventarioUI.innerText = 'Cargando inventario...';
            
            // --- ¡NUEVO! Limpiamos la "memoria" antes de recargar ---
            uidsDeGanado.clear();
            
            const querySnapshot = await getDocs(collection(db, "ganado"));
            
            if (querySnapshot.empty) {
                cargandoInventarioUI.innerText = 'Aún no hay ganado registrado.';
                return;
            }

            cargandoInventarioUI.style.display = 'none';

            querySnapshot.forEach((doc) => {
                const vaca = doc.data();
                const vacaId = doc.id; // El ID del documento (que es el UID)
                
                // --- ¡NUEVO! Añadimos el UID a la "memoria" ---
                uidsDeGanado.add(vacaId);
                
                const item = document.createElement('div');
                // --- ¡NUEVO! Añadimos un ID único a la tarjeta ---
                item.id = `vaca-${vacaId}`; 
                item.className = 'p-4 bg-white border rounded-lg shadow-sm item-vaca';

                // --- Lógica de Fechas (v4.10) ---
                let htmlCamposExtra = '';

                if (vaca.ultimoParto) {
                    const fechaUltimoParto = new Date(vaca.ultimoParto + 'T00:00:00');
                    htmlCamposExtra += `<p class="mt-2">Último Parto: ${fechaUltimoParto.toLocaleDateString('es-GT')}</p>`;
                }
                
                if (vaca.embarazada) {
                    htmlCamposExtra += `<p>Embarazada: <strong class="text-green-600">Sí</strong></p>`;
                    
                    if (vaca.estimadaParto) {
                        const fechaEstimada = new Date(vaca.estimadaParto + 'T00:00:00');
                        htmlCamposExtra += `<p class="font-medium text-blue-700">Fecha Estimada Parto: ${fechaEstimada.toLocaleDateString('es-GT')}</p>`;

                        const proximaOptimaPreño = new Date(fechaEstimada);
                        proximaOptimaPreño.setDate(proximaOptimaPreño.getDate() + 60);
                        htmlCamposExtra += `<p class="font-medium text-purple-700">Fecha Óptima Próx. Ciclo: ${proximaOptimaPreño.toLocaleDateString('es-GT')}</p>`;
                    }

                } else {
                    htmlCamposExtra += `<p>Embarazada: No</p>`;
                    if (vaca.ultimoParto) {
                        const fechaUltimoParto = new Date(vaca.ultimoParto + 'T00:00:00');
                        const fechaOptima = new Date(fechaUltimoParto);
                        fechaOptima.setDate(fechaOptima.getDate() + 60); 
                        
                        htmlCamposExtra += `<p class="font-medium text-green-700">Fecha Óptima Preño: ${fechaOptima.toLocaleDateString('es-GT')}</p>`;
                    }
                }
                // --- Fin de la lógica de fechas ---


                item.innerHTML = `
                    <h3 class="text-xl font-semibold text-blue-700">${vaca.nombre} (UID: <span class="font-mono">${vaca.uid}</span>)</h3>
                    <p>Edad: ${vaca.edad} años</p>
                    <p>Partos: ${vaca.partos}</p>
                    
                    ${htmlCamposExtra} 
                    
                    <div class="mt-2">
                        <button data-uid="${vacaId}" class="btn-editar bg-yellow-500 text-white px-3 py-1 rounded text-sm">
                            Editar
                        </button>
                        <button data-uid="${vacaId}" class="btn-eliminar bg-red-500 text-white px-3 py-1 rounded text-sm">
                            Eliminar
                        </button>
                    </div>
                `;
                inventarioUI.appendChild(item);
            });
        }
        
        // --- FUNCIÓN PARA ABRIR EL FORMULARIO DE EDICIÓN ---
        async function abrirFormularioEdicion(uid) {
            try {
                console.log(`Abriendo edición para: ${uid}`);
                const vacaRef = doc(db, "ganado", uid);
                const vacaSnap = await getDoc(vacaRef);

                if (!vacaSnap.exists()) {
                    alert("Error: No se encontró la vaca para editar.");
                    return;
                }

                const vaca = vacaSnap.data();

                formularioTituloUI.innerText = "Editar Vaca";
                document.getElementById('form-uid').value = vaca.uid;
                document.getElementById('form-scan-id').value = ''; // Modo edición
                document.getElementById('form-nombre').value = vaca.nombre || '';
                document.getElementById('form-edad').value = vaca.edad || 0;
                document.getElementById('form-partos').value = vaca.partos || 0;
                selectEmbarazada.value = vaca.embarazada ? 'true' : 'false';
                inputUltimoParto.value = vaca.ultimoParto || '';
                inputFechaEstimada.value = vaca.estimadaParto || '';

                if (vaca.embarazada) {
                    campoFechaEstimada.classList.remove('hidden');
                } else {
                    campoFechaEstimada.classList.add('hidden');
                }
                
                formularioUI.classList.remove('hidden');
                formularioUI.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Error al cargar datos para editar:", error);
                alert("No se pudieron cargar los datos de la vaca.");
            }
        }


        // --- LÓGICA DEL BUSCADOR ---
        inputBuscador.addEventListener('input', (e) => {
            const terminoBusqueda = e.target.value.toLowerCase();
            const itemsVaca = inventarioUI.querySelectorAll('.item-vaca'); 
            
            itemsVaca.forEach(item => {
                const nombreVaca = item.querySelector('h3').textContent.toLowerCase();
                
                if (nombreVaca.includes(terminoBusqueda)) {
                    item.style.display = 'block'; 
                } else {
                    item.style.display = 'none'; 
                }
            });
        });

        // --- LÓGICA PARA ELIMINAR Y EDITAR ---
        inventarioUI.addEventListener('click', async (e) => {
            
            if (e.target.classList.contains('btn-eliminar')) {
                const uid = e.target.dataset.uid;
                const confirmar = confirm(`¿Estás seguro de que quieres eliminar la vaca con UID: ${uid}? Esta acción no se puede deshacer.`);
                
                if (confirmar) {
                    try {
                        console.log(`Eliminando vaca: ${uid}`);
                        const vacaRef = doc(db, "ganado", uid);
                        await deleteDoc(vacaRef);

                        // --- ¡NUEVO! Quitar de la "memoria" ---
                        uidsDeGanado.delete(uid);
                        
                        alert("¡Vaca eliminada con éxito!");
                        await cargarInventario(); // Recargamos
                        
                    } catch (error) {
                        console.error("Error al eliminar la vaca:", error);
                        alert("Error al eliminar la vaca.");
                    }
                }
            }

            if (e.target.classList.contains('btn-editar')) {
                const uid = e.target.dataset.uid;
                await abrirFormularioEdicion(uid);
            }
        });

        // --- INICIAR TODO ---
        iniciarSistema();

    </script>

</body>
</html>